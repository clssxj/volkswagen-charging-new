# 并发冲突处理实现文档

## 功能概述

实现了完整的充电桩并发预约冲突处理机制，包括：
- ✅ 乐观锁
- ✅ 优先级判断
- ✅ 轮询重试
- ✅ 错误回滚
- ✅ 用户提示

## 实现文件

### src/utils/concurrency.ts
核心并发处理逻辑

### src/components/ChargingFlow.vue
集成并发检测到充电流程

### src/components/ConcurrencyTest.vue
并发场景测试工具

## 核心机制

### 1. 订单优先级

```typescript
enum OrderPriority {
  HIGH = 1,      // 高优先级（现场扫码）
  NORMAL = 2,    // 普通优先级（远程下单）
}

enum OrderSource {
  ONSITE_SCAN,   // 现场扫码 → 高优先级
  APP_REMOTE,    // APP远程 → 普通优先级
}
```

**优先级规则：**
- 现场扫码 > APP远程下单
- 相同优先级，先到先得

### 2. 乐观锁机制

```typescript
// 创建订单流程
async function createChargingOrder(connectorId, userId, source) {
  // Step 1: 乐观更新（先假设成功）
  const order = { orderId, connectorId, status: PENDING, ... }
  ordersMap.set(connectorId, [order])
  
  // Step 2: 检查并发冲突
  const conflict = checkConcurrentConflict(connectorId, order)
  
  if (conflict) {
    // Step 3: 有冲突，启动轮询
    const resolved = await pollForResolution(connectorId, order)
    
    if (!resolved.success) {
      // Step 4: 解决失败，回滚
      rollbackOrder(connectorId, orderId)
      return { success: false, error: '...' }
    }
  }
  
  // 成功
  order.status = CONFIRMED
  return { success: true, order }
}
```

### 3. 并发冲突检测

```typescript
function checkConcurrentConflict(connectorId, currentOrder) {
  const orders = ordersMap.get(connectorId) || []
  
  // 查找5秒内的其他待处理订单
  const competingOrders = orders.filter(o => 
    o.orderId !== currentOrder.orderId &&
    o.status === PENDING &&
    Math.abs(o.timestamp - currentOrder.timestamp) < 5000
  )
  
  if (competingOrders.length > 0) {
    return { hasConflict: true, competingOrders }
  }
  
  return null
}
```

### 4. 轮询解决冲突

```typescript
async function pollForResolution(connectorId, currentOrder) {
  const MAX_RETRIES = 5
  const RETRY_INTERVAL = 1000 // 1秒
  
  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
    await delay(RETRY_INTERVAL)
    
    // 检查竞争订单
    const competingOrders = getCompetingOrders(connectorId, currentOrder)
    
    if (competingOrders.length === 0) {
      return { success: true }
    }
    
    // 按优先级判断
    const hasHigherPriority = competingOrders.some(o => 
      o.priority < currentOrder.priority
    )
    
    if (hasHigherPriority && currentOrder.priority === NORMAL) {
      // 普通优先级让位给高优先级
      return { 
        success: false, 
        reason: '充电桩已被现场用户占用' 
      }
    }
    
    if (currentOrder.priority === HIGH) {
      // 高优先级抢占
      competingOrders.forEach(o => o.status = REJECTED)
      return { success: true }
    }
  }
  
  return { success: false, reason: '服务器繁忙，请稍后重试' }
}
```

## 使用流程

### 正常流程（无冲突）
```
用户点击"下一步"
  ↓
创建订单（乐观更新）
  ↓
检查冲突：无
  ↓
订单确认成功
  ↓
开始充电
```

### 并发冲突流程

#### 场景A：现场用户 vs 远程用户
```
时间轴：
t=0ms    远程用户A下单
t=100ms  现场用户B扫码
  ↓
并发检测：
- 远程A：轮询中...检测到现场用户B（高优先级）
         → 让位，订单失败
         → 提示："充电桩已被现场用户占用"
         
- 现场B：轮询中...抢占充电桩
         → 拒绝远程A的订单
         → 订单成功，开始充电
```

#### 场景B：相同优先级
```
时间轴：
t=0ms    远程用户A下单
t=50ms   远程用户C下单
  ↓
并发检测：
- 远程A：更早，优先获得
         → 订单成功
         
- 远程C：较晚，被拒绝
         → 提示："充电桩已被他人预约"
```

## 测试方法

### 方法1：使用测试组件（推荐）

在App.vue中添加测试按钮：
```vue
<ConcurrencyTest 
  v-if="showConcurrencyTest"
  :connectors="testConnectors"
  @close="showConcurrencyTest = false"
/>
```

### 方法2：Console测试

```javascript
// 导入测试函数
import { simulateConcurrentOrders } from '@/utils/concurrency'

// 运行测试
simulateConcurrentOrders('充电桩ID')

// 查看日志输出
```

### 方法3：真实场景测试

1. 打开两个浏览器窗口
2. 都进入同一充电站
3. 都点击"开始充电"
4. 选择同一个充电桩
5. 几乎同时点击"下一步"
6. 观察结果：
   - 一个成功（开始充电）
   - 另一个失败（显示错误提示）

## Console日志示例

```
🔄 创建订单: ORD-1234567890-ABC123
   充电桩: MA-0007-Q-03
   来源: APP远程
   优先级: 普通

🔍 发现1个竞争订单:
   - ORD-1234567991-XYZ789 (现场, 优先级:1)

🔄 开始轮询（最多5次）...
   尝试 1/5...
   尝试 2/5...
   ⚠️ 存在更高优先级订单: ORD-1234567991-XYZ789

❌ 订单被拒绝: 充电桩已被现场用户占用，请选择其他充电桩
🔙 订单已回滚: ORD-1234567890-ABC123
```

## 用户体验

### 成功场景
```
用户点击"下一步"
  ↓ (300-500ms检查)
✅ "充电桩预约成功，开始充电"
  ↓
进入充电中页面
```

### 失败场景
```
用户点击"下一步"
  ↓ (轮询5次，最多5秒)
❌ 弹窗提示：
   "充电桩预约失败
   
   充电桩已被现场用户占用，请选择其他充电桩
   
   请返回重新选择充电桩"
  ↓
自动返回选择充电桩页面
```

## 性能优化

1. **乐观更新** - 先假设成功，减少等待时间
2. **轮询间隔** - 1秒，平衡响应速度和服务器压力
3. **最大重试** - 5次，避免无限等待
4. **快速失败** - 检测到高优先级立即失败

---

已完成功能：
✅ 充电速度调慢（2秒/1%）
✅ 并发冲突处理
✅ 乐观锁机制
✅ 优先级判断
✅ 轮询重试
✅ 错误回滚
✅ 用户提示



