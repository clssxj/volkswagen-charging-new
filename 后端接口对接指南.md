# 后端接口对接指南

## 接口准备情况

✅ **项目已完整准备好后端接口对接代码！**

只需要简单配置即可切换到真实后端。

## 快速切换到后端

### 第1步：修改环境变量

编辑 `.env.local` 文件：

```env
# 修改前（使用Mock数据）
VITE_USE_MOCK=true

# 修改后（使用真实后端）
VITE_USE_MOCK=false

# 配置后端地址
VITE_API_BASE_URL=https://your-backend-api.com/api
VITE_WS_URL=wss://your-backend-api.com/ws
```

### 第2步：重启开发服务器

```bash
# 停止服务器 (Ctrl+C)
# 重新启动
npm run dev
```

**完成！** 现在所有API调用会自动转到真实后端。

---

## 已准备的接口代码

### 文件位置
`src/api/index.ts` - 统一的API接口层

### 接口列表

#### 1. 获取充电站列表（分页）
```typescript
export async function fetchStationList(params: {
  pageIndex?: number
  pageSize?: number
  lat?: number
  lng?: number
  radius?: number
}): Promise<StationListResponse>
```

**后端接口：**
```
GET /api/stations
Query参数：
  - pageIndex: 页码
  - pageSize: 每页数量
  - lat: 纬度（可选）
  - lng: 经度（可选）
  - radius: 半径km（可选）

响应格式：
{
  "pageIndex": 1,
  "pageSize": 10,
  "total": 2,
  "totalPage": 1,
  "stationList": [...]
}
```

#### 2. 根据地图边界获取充电站
```typescript
export async function fetchStationsByBounds(bounds: {
  northeast: { lat: number, lng: number }
  southwest: { lat: number, lng: number }
}): Promise<StationListItem[]>
```

**后端接口：**
```
POST /api/stations/bounds
Body:
{
  "northeast": { "lat": 32.0, "lng": 118.0 },
  "southwest": { "lat": 31.0, "lng": 117.0 }
}

响应：StationListItem[]
```

#### 3. 获取充电站详情
```typescript
export async function fetchStationDetail(
  stationId: string
): Promise<StationDetail | null>
```

**后端接口：**
```
GET /api/stations/:stationId

响应：StationDetail对象
```

#### 4. 搜索充电站
```typescript
export async function fetchSearchStations(
  keyword: string
): Promise<StationListItem[]>
```

**后端接口：**
```
GET /api/stations/search
Query: keyword=关键词

响应：StationListItem[]
```

#### 5. 获取附近充电站
```typescript
export async function fetchNearbyStations(
  lat: number, 
  lng: number, 
  radius: number = 10
): Promise<StationListItem[]>
```

**后端接口：**
```
GET /api/stations/nearby
Query:
  - lat: 纬度
  - lng: 经度
  - radius: 半径(km)

响应：StationListItem[]
```

---

## API层实现逻辑

### 自动切换Mock/真实后端

```typescript
// src/api/index.ts

// 根据环境变量判断
const USE_MOCK = import.meta.env.VITE_USE_MOCK === 'true'

export async function fetchStationList(params) {
  if (USE_MOCK) {
    // 使用Mock数据
    await mockDelay(200)
    return getMockStationList(params)
  }
  
  // 调用真实后端
  return apiClient.get('/stations', { params })
}
```

### Axios配置

```typescript
// 创建axios实例
const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
})

// 请求拦截器（可添加token）
apiClient.interceptors.request.use(config => {
  // 添加认证token
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// 响应拦截器
apiClient.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error)
    return Promise.reject(error)
  }
)
```

---

## WebSocket实时更新

### 代码位置
`src/utils/websocket.ts`

### 使用方式

**开发环境（Mock）：**
```typescript
// 使用定时器模拟
startRealtimeUpdate(mapStore, stationStore)
```

**生产环境（真实后端）：**
```typescript
// 连接WebSocket
const wsManager = initWebSocket(import.meta.env.VITE_WS_URL)

// 监听消息
wsManager.on('station_status_update', (data) => {
  // 更新充电站状态
})

wsManager.on('price_update', (data) => {
  // 更新价格
})
```

### 消息格式

```typescript
// 充电站状态更新
{
  "type": "station_status_update",
  "data": {
    "stationId": "AH-0001",
    "quickAvailableNum": 5,
    "slowAvailableNum": 3
  },
  "timestamp": 1698765432000
}

// 价格更新
{
  "type": "price_update",
  "data": {
    "stationId": "AH-0001",
    "periodPrices": [...]
  },
  "timestamp": 1698765432000
}
```

---

## 后端接口要求

### 必须实现的接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取充电站列表 | GET | /api/stations | 支持分页和附近查询 |
| 获取边界内充电站 | POST | /api/stations/bounds | 地图视野内查询 |
| 获取充电站详情 | GET | /api/stations/:id | 详情信息 |
| 搜索充电站 | GET | /api/stations/search | 关键词搜索 |
| 获取附近充电站 | GET | /api/stations/nearby | 基于位置查询 |

### 可选接口（推荐）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| WebSocket连接 | WS | /ws | 实时状态推送 |
| 创建充电订单 | POST | /api/orders | 充电订单 |
| 支付订单 | POST | /api/orders/:id/pay | 支付 |
| 用户登录 | POST | /api/auth/login | 用户认证 |

---

## 数据格式验证

### ✅ 所有字段已与后端样例对齐

**站点列表字段：**
- stationId, stationName, address, lat, lng
- quickChargeNum, quickAvailableNum
- slowChargeNum, slowAvailableNum
- totalCostPrice, electricityPrice, servicePrice
- 等... 完全匹配

**站点详情字段：**
- stationId, stationName, address
- stationLat, stationLng
- quickTotalCount, quickAvailableCount
- fastConnectors[], periodPrices[]
- 等... 完全匹配

---

## 测试后端对接

### 1. 本地测试

```bash
# 启动后端服务（假设端口8080）
# ...

# 配置环境变量
VITE_USE_MOCK=false
VITE_API_BASE_URL=http://localhost:8080/api

# 启动前端
npm run dev
```

### 2. 检查网络请求

打开浏览器开发者工具 → Network标签：
- 应该看到向 `http://localhost:8080/api/stations` 的请求
- 检查请求参数和响应格式

### 3. 错误处理

如果后端接口返回错误：
```typescript
// 已有完善的错误处理
apiClient.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error)
    // 可以添加错误提示
    alert('加载数据失败，请检查网络连接')
    return Promise.reject(error)
  }
)
```

---

## 🎯 总结

✅ **后端接口代码100%就绪！**

只需要：
1. 修改 `.env.local` 中的 `VITE_USE_MOCK=false`
2. 配置后端地址
3. 重启开发服务器

**无需修改任何代码，即可无缝切换到真实后端！**


