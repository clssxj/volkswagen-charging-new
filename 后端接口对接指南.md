# åç«¯æ¥å£å¯¹æ¥æŒ‡å—

## æ¥å£å‡†å¤‡æƒ…å†µ

âœ… **é¡¹ç›®å·²å®Œæ•´å‡†å¤‡å¥½åç«¯æ¥å£å¯¹æ¥ä»£ç ï¼**

åªéœ€è¦ç®€å•é…ç½®å³å¯åˆ‡æ¢åˆ°çœŸå®åç«¯ã€‚

## å¿«é€Ÿåˆ‡æ¢åˆ°åç«¯

### ç¬¬1æ­¥ï¼šä¿®æ”¹ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env.local` æ–‡ä»¶ï¼š

```env
# ä¿®æ”¹å‰ï¼ˆä½¿ç”¨Mockæ•°æ®ï¼‰
VITE_USE_MOCK=true

# ä¿®æ”¹åï¼ˆä½¿ç”¨çœŸå®åç«¯ï¼‰
VITE_USE_MOCK=false

# é…ç½®åç«¯åœ°å€
VITE_API_BASE_URL=https://your-backend-api.com/api
VITE_WS_URL=wss://your-backend-api.com/ws
```

### ç¬¬2æ­¥ï¼šé‡å¯å¼€å‘æœåŠ¡å™¨

```bash
# åœæ­¢æœåŠ¡å™¨ (Ctrl+C)
# é‡æ–°å¯åŠ¨
npm run dev
```

**å®Œæˆï¼** ç°åœ¨æ‰€æœ‰APIè°ƒç”¨ä¼šè‡ªåŠ¨è½¬åˆ°çœŸå®åç«¯ã€‚

---

## å·²å‡†å¤‡çš„æ¥å£ä»£ç 

### æ–‡ä»¶ä½ç½®
`src/api/index.ts` - ç»Ÿä¸€çš„APIæ¥å£å±‚

### æ¥å£åˆ—è¡¨

#### 1. è·å–å……ç”µç«™åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
```typescript
export async function fetchStationList(params: {
  pageIndex?: number
  pageSize?: number
  lat?: number
  lng?: number
  radius?: number
}): Promise<StationListResponse>
```

**åç«¯æ¥å£ï¼š**
```
GET /api/stations
Queryå‚æ•°ï¼š
  - pageIndex: é¡µç 
  - pageSize: æ¯é¡µæ•°é‡
  - lat: çº¬åº¦ï¼ˆå¯é€‰ï¼‰
  - lng: ç»åº¦ï¼ˆå¯é€‰ï¼‰
  - radius: åŠå¾„kmï¼ˆå¯é€‰ï¼‰

å“åº”æ ¼å¼ï¼š
{
  "pageIndex": 1,
  "pageSize": 10,
  "total": 2,
  "totalPage": 1,
  "stationList": [...]
}
```

#### 2. æ ¹æ®åœ°å›¾è¾¹ç•Œè·å–å……ç”µç«™
```typescript
export async function fetchStationsByBounds(bounds: {
  northeast: { lat: number, lng: number }
  southwest: { lat: number, lng: number }
}): Promise<StationListItem[]>
```

**åç«¯æ¥å£ï¼š**
```
POST /api/stations/bounds
Body:
{
  "northeast": { "lat": 32.0, "lng": 118.0 },
  "southwest": { "lat": 31.0, "lng": 117.0 }
}

å“åº”ï¼šStationListItem[]
```

#### 3. è·å–å……ç”µç«™è¯¦æƒ…
```typescript
export async function fetchStationDetail(
  stationId: string
): Promise<StationDetail | null>
```

**åç«¯æ¥å£ï¼š**
```
GET /api/stations/:stationId

å“åº”ï¼šStationDetailå¯¹è±¡
```

#### 4. æœç´¢å……ç”µç«™
```typescript
export async function fetchSearchStations(
  keyword: string
): Promise<StationListItem[]>
```

**åç«¯æ¥å£ï¼š**
```
GET /api/stations/search
Query: keyword=å…³é”®è¯

å“åº”ï¼šStationListItem[]
```

#### 5. è·å–é™„è¿‘å……ç”µç«™
```typescript
export async function fetchNearbyStations(
  lat: number, 
  lng: number, 
  radius: number = 10
): Promise<StationListItem[]>
```

**åç«¯æ¥å£ï¼š**
```
GET /api/stations/nearby
Query:
  - lat: çº¬åº¦
  - lng: ç»åº¦
  - radius: åŠå¾„(km)

å“åº”ï¼šStationListItem[]
```

---

## APIå±‚å®ç°é€»è¾‘

### è‡ªåŠ¨åˆ‡æ¢Mock/çœŸå®åç«¯

```typescript
// src/api/index.ts

// æ ¹æ®ç¯å¢ƒå˜é‡åˆ¤æ–­
const USE_MOCK = import.meta.env.VITE_USE_MOCK === 'true'

export async function fetchStationList(params) {
  if (USE_MOCK) {
    // ä½¿ç”¨Mockæ•°æ®
    await mockDelay(200)
    return getMockStationList(params)
  }
  
  // è°ƒç”¨çœŸå®åç«¯
  return apiClient.get('/stations', { params })
}
```

### Axiosé…ç½®

```typescript
// åˆ›å»ºaxioså®ä¾‹
const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
})

// è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆå¯æ·»åŠ tokenï¼‰
apiClient.interceptors.request.use(config => {
  // æ·»åŠ è®¤è¯token
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// å“åº”æ‹¦æˆªå™¨
apiClient.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error)
    return Promise.reject(error)
  }
)
```

---

## WebSocketå®æ—¶æ›´æ–°

### ä»£ç ä½ç½®
`src/utils/websocket.ts`

### ä½¿ç”¨æ–¹å¼

**å¼€å‘ç¯å¢ƒï¼ˆMockï¼‰ï¼š**
```typescript
// ä½¿ç”¨å®šæ—¶å™¨æ¨¡æ‹Ÿ
startRealtimeUpdate(mapStore, stationStore)
```

**ç”Ÿäº§ç¯å¢ƒï¼ˆçœŸå®åç«¯ï¼‰ï¼š**
```typescript
// è¿æ¥WebSocket
const wsManager = initWebSocket(import.meta.env.VITE_WS_URL)

// ç›‘å¬æ¶ˆæ¯
wsManager.on('station_status_update', (data) => {
  // æ›´æ–°å……ç”µç«™çŠ¶æ€
})

wsManager.on('price_update', (data) => {
  // æ›´æ–°ä»·æ ¼
})
```

### æ¶ˆæ¯æ ¼å¼

```typescript
// å……ç”µç«™çŠ¶æ€æ›´æ–°
{
  "type": "station_status_update",
  "data": {
    "stationId": "AH-0001",
    "quickAvailableNum": 5,
    "slowAvailableNum": 3
  },
  "timestamp": 1698765432000
}

// ä»·æ ¼æ›´æ–°
{
  "type": "price_update",
  "data": {
    "stationId": "AH-0001",
    "periodPrices": [...]
  },
  "timestamp": 1698765432000
}
```

---

## åç«¯æ¥å£è¦æ±‚

### å¿…é¡»å®ç°çš„æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| è·å–å……ç”µç«™åˆ—è¡¨ | GET | /api/stations | æ”¯æŒåˆ†é¡µå’Œé™„è¿‘æŸ¥è¯¢ |
| è·å–è¾¹ç•Œå†…å……ç”µç«™ | POST | /api/stations/bounds | åœ°å›¾è§†é‡å†…æŸ¥è¯¢ |
| è·å–å……ç”µç«™è¯¦æƒ… | GET | /api/stations/:id | è¯¦æƒ…ä¿¡æ¯ |
| æœç´¢å……ç”µç«™ | GET | /api/stations/search | å…³é”®è¯æœç´¢ |
| è·å–é™„è¿‘å……ç”µç«™ | GET | /api/stations/nearby | åŸºäºä½ç½®æŸ¥è¯¢ |

### å¯é€‰æ¥å£ï¼ˆæ¨èï¼‰

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| WebSocketè¿æ¥ | WS | /ws | å®æ—¶çŠ¶æ€æ¨é€ |
| åˆ›å»ºå……ç”µè®¢å• | POST | /api/orders | å……ç”µè®¢å• |
| æ”¯ä»˜è®¢å• | POST | /api/orders/:id/pay | æ”¯ä»˜ |
| ç”¨æˆ·ç™»å½• | POST | /api/auth/login | ç”¨æˆ·è®¤è¯ |

---

## æ•°æ®æ ¼å¼éªŒè¯

### âœ… æ‰€æœ‰å­—æ®µå·²ä¸åç«¯æ ·ä¾‹å¯¹é½

**ç«™ç‚¹åˆ—è¡¨å­—æ®µï¼š**
- stationId, stationName, address, lat, lng
- quickChargeNum, quickAvailableNum
- slowChargeNum, slowAvailableNum
- totalCostPrice, electricityPrice, servicePrice
- ç­‰... å®Œå…¨åŒ¹é…

**ç«™ç‚¹è¯¦æƒ…å­—æ®µï¼š**
- stationId, stationName, address
- stationLat, stationLng
- quickTotalCount, quickAvailableCount
- fastConnectors[], periodPrices[]
- ç­‰... å®Œå…¨åŒ¹é…

---

## æµ‹è¯•åç«¯å¯¹æ¥

### 1. æœ¬åœ°æµ‹è¯•

```bash
# å¯åŠ¨åç«¯æœåŠ¡ï¼ˆå‡è®¾ç«¯å£8080ï¼‰
# ...

# é…ç½®ç¯å¢ƒå˜é‡
VITE_USE_MOCK=false
VITE_API_BASE_URL=http://localhost:8080/api

# å¯åŠ¨å‰ç«¯
npm run dev
```

### 2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Networkæ ‡ç­¾ï¼š
- åº”è¯¥çœ‹åˆ°å‘ `http://localhost:8080/api/stations` çš„è¯·æ±‚
- æ£€æŸ¥è¯·æ±‚å‚æ•°å’Œå“åº”æ ¼å¼

### 3. é”™è¯¯å¤„ç†

å¦‚æœåç«¯æ¥å£è¿”å›é”™è¯¯ï¼š
```typescript
// å·²æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†
apiClient.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error)
    // å¯ä»¥æ·»åŠ é”™è¯¯æç¤º
    alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
    return Promise.reject(error)
  }
)
```

---

## ğŸ¯ æ€»ç»“

âœ… **åç«¯æ¥å£ä»£ç 100%å°±ç»ªï¼**

åªéœ€è¦ï¼š
1. ä¿®æ”¹ `.env.local` ä¸­çš„ `VITE_USE_MOCK=false`
2. é…ç½®åç«¯åœ°å€
3. é‡å¯å¼€å‘æœåŠ¡å™¨

**æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå³å¯æ— ç¼åˆ‡æ¢åˆ°çœŸå®åç«¯ï¼**


