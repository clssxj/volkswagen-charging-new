# å¹¶å‘å†²çªæµ‹è¯•ä½¿ç”¨æŒ‡å—

## å¿«é€Ÿæµ‹è¯•æ­¥éª¤

### æ–¹æ³•1ï¼šè‡ªåŠ¨å¹¶å‘æµ‹è¯•ï¼ˆæ¨èï¼‰

1. **æ‰“å¼€æµè§ˆå™¨Console (F12)**

2. **è¿è¡Œæµ‹è¯•ä»£ç ï¼š**
```javascript
// å¯¼å…¥æµ‹è¯•å‡½æ•°
const { simulateConcurrentOrders } = await import('/src/utils/concurrency.ts')

// æ¨¡æ‹Ÿä¸¤äººåŒæ—¶é¢„çº¦åŒä¸€å……ç”µæ¡©
// å‚æ•°ï¼šå……ç”µæ¡©IDï¼ˆå¯ä»¥ä»è¯¦æƒ…é¡µçœ‹åˆ°ï¼‰
await simulateConcurrentOrders('AH-0001-Q-01')
```

3. **æŸ¥çœ‹Consoleè¾“å‡º**

åº”è¯¥çœ‹åˆ°ç±»ä¼¼æ—¥å¿—ï¼š
```
ğŸ­ ===== æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯ =====
å……ç”µæ¡©: AH-0001-Q-01

ğŸ”„ åˆ›å»ºè®¢å•: ORD-xxx-AAA (è¿œç¨‹ä¸‹å•, æ™®é€šä¼˜å…ˆçº§)
ğŸ”„ åˆ›å»ºè®¢å•: ORD-xxx-BBB (ç°åœºæ‰«ç , é«˜ä¼˜å…ˆçº§)

ğŸ” å‘ç°1ä¸ªç«äº‰è®¢å•
ğŸ”„ å¼€å§‹è½®è¯¢...
âš ï¸ å­˜åœ¨æ›´é«˜ä¼˜å…ˆçº§è®¢å•
âŒ è®¢å•è¢«æ‹’ç»: å……ç”µæ¡©å·²è¢«ç°åœºç”¨æˆ·å ç”¨

âœ… å½“å‰è®¢å•ä¼˜å…ˆçº§æ›´é«˜ï¼ŒæŠ¢å å……ç”µæ¡©

ğŸ“Š ===== å¹¶å‘æµ‹è¯•ç»“æœ =====
è¿œç¨‹è®¢å•: âŒ å¤±è´¥ - å……ç”µæ¡©å·²è¢«ç°åœºç”¨æˆ·å ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–å……ç”µæ¡©
ç°åœºè®¢å•: âœ… æˆåŠŸ

é¢„æœŸç»“æœ: ç°åœºè®¢å•åº”è¯¥æˆåŠŸï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼Œè¿œç¨‹è®¢å•åº”è¯¥å¤±è´¥
âœ… æµ‹è¯•é€šè¿‡ï¼
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æ¨¡æ‹Ÿï¼ˆçœŸå®åœºæ™¯ï¼‰

1. **æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£** (å¹¶æ’æ˜¾ç¤º)

2. **çª—å£Aï¼ˆæ¨¡æ‹Ÿè¿œç¨‹ç”¨æˆ·ï¼‰ï¼š**
   - è¿›å…¥å……ç”µç«™è¯¦æƒ…
   - ç‚¹å‡»"å¼€å§‹å……ç”µ"
   - é€‰æ‹©å……ç”µæ¡©ï¼ˆä¾‹å¦‚ï¼šè½¦ä½å·3ï¼‰
   - **å‡†å¤‡ç‚¹å‡»"ä¸‹ä¸€æ­¥"ï¼Œä½†å…ˆä¸ç‚¹**

3. **çª—å£Bï¼ˆæ¨¡æ‹Ÿç°åœºç”¨æˆ·ï¼‰ï¼š**
   - è¿›å…¥åŒä¸€å……ç”µç«™
   - ç‚¹å‡»"å¼€å§‹å……ç”µ"
   - é€‰æ‹©**ç›¸åŒçš„å……ç”µæ¡©**ï¼ˆè½¦ä½å·3ï¼‰
   - **å‡†å¤‡ç‚¹å‡»"ä¸‹ä¸€æ­¥"**

4. **åŒæ—¶ç‚¹å‡»ä¸¤ä¸ªçª—å£çš„"ä¸‹ä¸€æ­¥"æŒ‰é’®**

5. **è§‚å¯Ÿç»“æœï¼š**
   - çª—å£Aï¼ˆè¿œç¨‹ï¼‰ï¼šåº”è¯¥æ˜¾ç¤ºå¤±è´¥æç¤º
   - çª—å£Bï¼ˆç°åœºï¼‰ï¼šåº”è¯¥æˆåŠŸè¿›å…¥å……ç”µé¡µé¢

## æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šç°åœºä¼˜å…ˆ
```
è¿œç¨‹ç”¨æˆ·A (t=0ms)     ç°åœºç”¨æˆ·B (t=100ms)
      â†“                       â†“
   åˆ›å»ºè®¢å•                åˆ›å»ºè®¢å•
      â†“                       â†“
  æ£€æµ‹åˆ°å†²çª              æ£€æµ‹åˆ°å†²çª
      â†“                       â†“
   å¼€å§‹è½®è¯¢                å¼€å§‹è½®è¯¢
      â†“                       â†“
 å‘ç°é«˜ä¼˜å…ˆçº§ç”¨æˆ·         æˆ‘æ˜¯é«˜ä¼˜å…ˆçº§
      â†“                       â†“
   âŒ å¤±è´¥                 âœ… æˆåŠŸæŠ¢å 
   è®©ä½é€€å‡º                 å¼€å§‹å……ç”µ
```

### åœºæ™¯2ï¼šå…ˆåˆ°å…ˆå¾—ï¼ˆç›¸åŒä¼˜å…ˆçº§ï¼‰
```
è¿œç¨‹ç”¨æˆ·A (t=0ms)     è¿œç¨‹ç”¨æˆ·C (t=200ms)
      â†“                       â†“
   åˆ›å»ºè®¢å•                åˆ›å»ºè®¢å•
      â†“                       â†“
  æ— å†²çª                  æ£€æµ‹åˆ°å†²çª
      â†“                       â†“
   âœ… ç«‹å³æˆåŠŸ            å¼€å§‹è½®è¯¢
   å¼€å§‹å……ç”µ                   â†“
                        å‘ç°æ›´æ—©çš„è®¢å•
                              â†“
                          âŒ å¤±è´¥
                          è¿”å›é€‰æ‹©
```

### åœºæ™¯3ï¼šè½®è¯¢è¶…æ—¶
```
ç”¨æˆ·ä¸‹å•
  â†“
æ£€æµ‹åˆ°å†²çªï¼ˆå¯¹æ–¹å¡åœ¨æŸä¸ªçŠ¶æ€ï¼‰
  â†“
è½®è¯¢é‡è¯•: 1æ¬¡
è½®è¯¢é‡è¯•: 2æ¬¡
è½®è¯¢é‡è¯•: 3æ¬¡
è½®è¯¢é‡è¯•: 4æ¬¡
è½®è¯¢é‡è¯•: 5æ¬¡
  â†“
âŒ è¶…æ—¶å¤±è´¥
æç¤º: "æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"
```

## å……ç”µé€Ÿåº¦è°ƒæ•´

### ä¿®æ”¹å‰ âŒ
```
æ¯200ms â†’ +2% â†’ 10ç§’å……æ»¡
å¤ªå¿«ï¼Œä¸çœŸå®
```

### ä¿®æ”¹å âœ…
```
æ¯2ç§’ â†’ +1% â†’ 200ç§’(3.3åˆ†é’Ÿ)å……æ»¡
æ›´æ¥è¿‘çœŸå®å……ç”µæ—¶é•¿
```

**è°ƒæ•´å‚æ•°ï¼š**
```typescript
chargingTimer = setInterval(() => {
  chargingProgress.value += 1     // æ¯æ¬¡1%ï¼ˆä¹‹å‰2%ï¼‰
  chargingDuration.value += 2     // ç´¯è®¡2åˆ†é’Ÿï¼ˆä¹‹å‰1åˆ†é’Ÿï¼‰
}, 2000)  // 2ç§’é—´éš”ï¼ˆä¹‹å‰200msï¼‰
```

## ç”¨æˆ·æç¤ºæ¶ˆæ¯

### æˆåŠŸæç¤º
```
âœ… å……ç”µæ¡©é¢„çº¦æˆåŠŸï¼Œå¼€å§‹å……ç”µ
```

### å¤±è´¥æç¤º

**é«˜ä¼˜å…ˆçº§æŠ¢å ï¼š**
```
âŒ å……ç”µæ¡©é¢„çº¦å¤±è´¥

å……ç”µæ¡©å·²è¢«ç°åœºç”¨æˆ·å ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–å……ç”µæ¡©

[ç¡®å®š]
```

**å·²è¢«ä»–äººé¢„çº¦ï¼š**
```
âŒ å……ç”µæ¡©é¢„çº¦å¤±è´¥

å……ç”µæ¡©å·²è¢«ä»–äººé¢„çº¦ï¼Œè¯·é€‰æ‹©å…¶ä»–å……ç”µæ¡©

[ç¡®å®š]
```

**æœåŠ¡å™¨ç¹å¿™ï¼š**
```
âŒ å……ç”µæ¡©é¢„çº¦å¤±è´¥

æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•

[ç¡®å®š]
```

## è°ƒè¯•æ–¹æ³•

### æŸ¥çœ‹è®¢å•åˆ—è¡¨
```javascript
import { getConnectorOrders } from '@/utils/concurrency'

// æŸ¥çœ‹æŸä¸ªå……ç”µæ¡©çš„æ‰€æœ‰è®¢å•
const orders = getConnectorOrders('AH-0001-Q-01')
console.log('è®¢å•åˆ—è¡¨:', orders)
```

### æ¸…é™¤æ‰€æœ‰è®¢å•
```javascript
import { clearAllOrders } from '@/utils/concurrency'

clearAllOrders()
console.log('æ‰€æœ‰è®¢å•å·²æ¸…é™¤')
```

### æ‰‹åŠ¨æ¨¡æ‹Ÿå†²çª
```javascript
import { createChargingOrder, OrderSource } from '@/utils/concurrency'

// å‡ ä¹åŒæ—¶åˆ›å»ºä¸¤ä¸ªè®¢å•
const p1 = createChargingOrder('AH-0001-Q-01', 'user1', OrderSource.APP_REMOTE)
const p2 = createChargingOrder('AH-0001-Q-01', 'user2', OrderSource.ONSITE_SCAN)

const [r1, r2] = await Promise.all([p1, p2])

console.log('è¿œç¨‹ç”¨æˆ·:', r1.success ? 'æˆåŠŸ' : 'å¤±è´¥')
console.log('ç°åœºç”¨æˆ·:', r2.success ? 'æˆåŠŸ' : 'å¤±è´¥')
```

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|---|------|
| å¹¶å‘æ£€æµ‹å»¶è¿Ÿ | 300-500ms | ç½‘ç»œæ¨¡æ‹Ÿ |
| è½®è¯¢é—´éš” | 1ç§’ | å¹³è¡¡å“åº”å’Œå‹åŠ› |
| æœ€å¤§è½®è¯¢æ¬¡æ•° | 5æ¬¡ | æœ€å¤š5ç§’ |
| å†²çªæ£€æµ‹çª—å£ | 5ç§’ | 5ç§’å†…çš„è®¢å•è§†ä¸ºå†²çª |
| å……ç”µè¿›åº¦æ›´æ–° | 2ç§’ | æ¯2ç§’+1% |

---

å·²å®Œæˆï¼ç°åœ¨ç³»ç»Ÿå¯ä»¥æ­£ç¡®å¤„ç†å¹¶å‘å†²çªäº†ã€‚



