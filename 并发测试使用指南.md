# 并发冲突测试使用指南

## 快速测试步骤

### 方法1：自动并发测试（推荐）

1. **打开浏览器Console (F12)**

2. **运行测试代码：**
```javascript
// 导入测试函数
const { simulateConcurrentOrders } = await import('/src/utils/concurrency.ts')

// 模拟两人同时预约同一充电桩
// 参数：充电桩ID（可以从详情页看到）
await simulateConcurrentOrders('AH-0001-Q-01')
```

3. **查看Console输出**

应该看到类似日志：
```
🎭 ===== 模拟并发场景 =====
充电桩: AH-0001-Q-01

🔄 创建订单: ORD-xxx-AAA (远程下单, 普通优先级)
🔄 创建订单: ORD-xxx-BBB (现场扫码, 高优先级)

🔍 发现1个竞争订单
🔄 开始轮询...
⚠️ 存在更高优先级订单
❌ 订单被拒绝: 充电桩已被现场用户占用

✅ 当前订单优先级更高，抢占充电桩

📊 ===== 并发测试结果 =====
远程订单: ❌ 失败 - 充电桩已被现场用户占用，请选择其他充电桩
现场订单: ✅ 成功

预期结果: 现场订单应该成功（高优先级），远程订单应该失败
✅ 测试通过！
```

### 方法2：手动模拟（真实场景）

1. **打开两个浏览器窗口** (并排显示)

2. **窗口A（模拟远程用户）：**
   - 进入充电站详情
   - 点击"开始充电"
   - 选择充电桩（例如：车位号3）
   - **准备点击"下一步"，但先不点**

3. **窗口B（模拟现场用户）：**
   - 进入同一充电站
   - 点击"开始充电"
   - 选择**相同的充电桩**（车位号3）
   - **准备点击"下一步"**

4. **同时点击两个窗口的"下一步"按钮**

5. **观察结果：**
   - 窗口A（远程）：应该显示失败提示
   - 窗口B（现场）：应该成功进入充电页面

## 测试场景

### 场景1：现场优先
```
远程用户A (t=0ms)     现场用户B (t=100ms)
      ↓                       ↓
   创建订单                创建订单
      ↓                       ↓
  检测到冲突              检测到冲突
      ↓                       ↓
   开始轮询                开始轮询
      ↓                       ↓
 发现高优先级用户         我是高优先级
      ↓                       ↓
   ❌ 失败                 ✅ 成功抢占
   让位退出                 开始充电
```

### 场景2：先到先得（相同优先级）
```
远程用户A (t=0ms)     远程用户C (t=200ms)
      ↓                       ↓
   创建订单                创建订单
      ↓                       ↓
  无冲突                  检测到冲突
      ↓                       ↓
   ✅ 立即成功            开始轮询
   开始充电                   ↓
                        发现更早的订单
                              ↓
                          ❌ 失败
                          返回选择
```

### 场景3：轮询超时
```
用户下单
  ↓
检测到冲突（对方卡在某个状态）
  ↓
轮询重试: 1次
轮询重试: 2次
轮询重试: 3次
轮询重试: 4次
轮询重试: 5次
  ↓
❌ 超时失败
提示: "服务器繁忙，请稍后重试"
```

## 充电速度调整

### 修改前 ❌
```
每200ms → +2% → 10秒充满
太快，不真实
```

### 修改后 ✅
```
每2秒 → +1% → 200秒(3.3分钟)充满
更接近真实充电时长
```

**调整参数：**
```typescript
chargingTimer = setInterval(() => {
  chargingProgress.value += 1     // 每次1%（之前2%）
  chargingDuration.value += 2     // 累计2分钟（之前1分钟）
}, 2000)  // 2秒间隔（之前200ms）
```

## 用户提示消息

### 成功提示
```
✅ 充电桩预约成功，开始充电
```

### 失败提示

**高优先级抢占：**
```
❌ 充电桩预约失败

充电桩已被现场用户占用，请选择其他充电桩

[确定]
```

**已被他人预约：**
```
❌ 充电桩预约失败

充电桩已被他人预约，请选择其他充电桩

[确定]
```

**服务器繁忙：**
```
❌ 充电桩预约失败

服务器繁忙，请稍后重试

[确定]
```

## 调试方法

### 查看订单列表
```javascript
import { getConnectorOrders } from '@/utils/concurrency'

// 查看某个充电桩的所有订单
const orders = getConnectorOrders('AH-0001-Q-01')
console.log('订单列表:', orders)
```

### 清除所有订单
```javascript
import { clearAllOrders } from '@/utils/concurrency'

clearAllOrders()
console.log('所有订单已清除')
```

### 手动模拟冲突
```javascript
import { createChargingOrder, OrderSource } from '@/utils/concurrency'

// 几乎同时创建两个订单
const p1 = createChargingOrder('AH-0001-Q-01', 'user1', OrderSource.APP_REMOTE)
const p2 = createChargingOrder('AH-0001-Q-01', 'user2', OrderSource.ONSITE_SCAN)

const [r1, r2] = await Promise.all([p1, p2])

console.log('远程用户:', r1.success ? '成功' : '失败')
console.log('现场用户:', r2.success ? '成功' : '失败')
```

## 性能指标

| 指标 | 值 | 说明 |
|------|---|------|
| 并发检测延迟 | 300-500ms | 网络模拟 |
| 轮询间隔 | 1秒 | 平衡响应和压力 |
| 最大轮询次数 | 5次 | 最多5秒 |
| 冲突检测窗口 | 5秒 | 5秒内的订单视为冲突 |
| 充电进度更新 | 2秒 | 每2秒+1% |

---

已完成！现在系统可以正确处理并发冲突了。



